// ============================================
// Organization Model (Multi-Tenant)
// ============================================
model Organization {
  id             Int       @id @default(autoincrement())
  name           String    // "Prefeitura de São Paulo"
  slug           String    @unique // "sp"
  domain         String?   @unique // "sp.memoriaviva.com.br"
  logo           String?   // URL to logo
  primaryColor   String    @default("#4B0082") // Purple
  secondaryColor String    @default("#D4AF37") // Gold
  config         String?   // JSON: { aiInstructions, features, etc }
  isActive       Boolean   @default(true)
  
  // Limits and Quotas
  storageLimit   Int       @default(5) // GB
  userLimit      Int       @default(10)
  aiTokenLimit   Int       @default(100000) // Monthly limit
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  expenses       Expense[]

  users          User[]
  memories       Memory[]
  aiLogs         AiLog[]
  auditLogs      AuditLog[]
  aiUsages       AiUsage[]
  roles          Role[]
  agents         Agent[]
  
  schoolUnits    SchoolUnit[] // [NEW]
  lessonPlans    LessonPlan[] // [NEW]
}

model AiLog {
  id             Int          @id @default(autoincrement())
  inputContext   String?      // Text input or metadata about the file
  promptUsed     String       // The full prompt sent to AI
  aiOutput       String       // The raw response from AI
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  userId         Int?
  createdAt      DateTime     @default(now())
}

model AuditLog {
  id             Int          @id @default(autoincrement())
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  userId         Int?
  action         String       // "CREATE_USER", "DELETE_MEMORY", "SUSPEND_ORG"
  details        String?      // JSON details
  ipAddress      String?
  createdAt      DateTime     @default(now())
}

model AiUsage {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  date           DateTime     @default(now()) // YYYY-MM-DD
  tokensUsed     Int          @default(0)
  cost           Float        @default(0.0)
  model          String       // "gemini-pro"
  
  @@unique([organizationId, date, model])
}

model SystemSettings {
  id             Int       @id @default(autoincrement())
  key            String    @unique // "global_ai_model", "maintenance_mode"
  value          String    // JSON value
  description    String?
  updatedAt      DateTime  @updatedAt
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  schoolUnitId   Int?         // [NEW] Relation to SchoolUnit
  schoolUnit     SchoolUnit?  @relation(fields: [schoolUnitId], references: [id])
  
  name           String
  email          String       @unique
  password       String
  role           String       @default("user") // Deprecated
  roleId         Int?         
  userRole       Role?        @relation(fields: [roleId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  memories       Memory[]
  lessonPlans    LessonPlan[]
}

// [NEW] Unidade Escolar (CMEI/Escola)
model SchoolUnit {
  id             Int          @id @default(autoincrement())
  name           String       // "CMEI Ana Carolina"
  inepCode       String?      // Código INEP (Opcional)
  address        String?      // Endereço para Geolocalização futura
  
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  users          User[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

// [NEW] Plano de Aula (Persistência)
model LessonPlan {
  id             Int          @id @default(autoincrement())
  
  title          String
  gradeLevel     String       // "Grupo 5 - Educação Infantil"
  subject        String?      // "Artes" ou null (EI)
  topic          String?
  
  content        String       // JSON stringified do plano completo
  
  userId         Int
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId])
  @@index([userId])
}

model Role {
  id             Int          @id @default(autoincrement())
  name           String       // "Admin", "Editor", "Fotógrafo"
  description    String?
  slug           String       // "admin", "editor" - unique per organization
  permissions    String       // JSON: { "memories": ["create", "read"], "users": [] }
  isSystem       Boolean      @default(false) // Cannot be deleted
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, slug])
}

model Memory {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         Int
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String
  description    String?
  content        String
  eventDate      DateTime?
  isEvent        Boolean      @default(false)
  ticketPrice    Float?
  capacity       Int?
  location       String?
  category       String?
  tags           String?      // JSON array of tags
  mediaUrl       String?
  documentUrl    String?      // URL to PDF/Doc/Txt file
  audioUrl       String?      // URL to audio recording if available
  isPublic       Boolean      @default(false)
  curationScore  Int          @default(0)
  aiGenerated    Boolean      @default(false)
  
  // [NEW] Smart Player Columns
  transcription  String?      // Full transcript text
  chapters       String?      // JSON: [{timestamp: "02:15", title: "Intro"}]

  // [NEW] Curadoria
  status         String       @default("PENDING") // Enum: "PENDING", "APPROVED", "REJECTED"
  
  // [NEW] Metadados Técnicos
  metadata       String?      // JSON: { duration, resolution, size, originalName }
  thumbnailUrl   String?      // URL to thumbnail image

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  expenses       Expense[]
  
  eventId        Int?
  event          Memory?  @relation("EventMemories", fields: [eventId], references: [id])
  relatedMemories Memory[] @relation("EventMemories")
}

model Expense {
  id             Int      @id @default(autoincrement())
  description    String
  amount         Float
  date           DateTime
  category       String   // "Equipment", "Personnel", "Marketing"
  
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  memoryId       Int?
  memory         Memory?  @relation(fields: [memoryId], references: [id])
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Agent {
  id             Int          @id @default(autoincrement())
  
  // Multi-tenancy Isolation
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Descobertas e Metadados Visuais
  name           String       // "Roberto"
  role           String       // "Consultor"
  description    String       // Texto curto para o card
  avatarUrl      String?      // URL de imagem (opcional)

  // [NEW] Customização de UI
  icon           String       @default("Bot") // Nome do ícone Lucide: "Bot", "Briefcase", "GraduationCap"
  color          String       @default("blue-600") // Classe de cor do Tailwind: "blue-600", "pink-600"

  // [NEW] Visibilidade
  isGlobal       Boolean      @default(false) // Se true, aparece para TODAS as organizações
  isActive       Boolean      @default(true)
  
  // The Brain
  systemPrompt   String       @default("") // The "brain" of the agent
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}
